@RestController
@RequestMapping("/api/webtoons")
@RequiredArgsConstructor
@CrossOrigin(origins = "http://localhost:5173")
public class WebtoonController {

    private final WebtoonRepository webtoonRepository;
    private final GeminiService geminiService; // 지난번에 만든 AI 서비스

    // 1. 목록 조회 (검색/필터는 일단 간단하게 전체조회 후 뷰에서 처리하거나 쿼리 추가)
    @GetMapping
    public List<Webtoon> getAllWebtoons() {
        return webtoonRepository.findAll(Sort.by(Sort.Direction.DESC, "id"));
    }

    // 2. 작품 등록
    @PostMapping
    public Webtoon createWebtoon(@RequestBody Webtoon webtoon) {
        return webtoonRepository.save(webtoon);
    }

    // 3. 작품 수정
    @PutMapping("/{id}")
    public Webtoon updateWebtoon(@PathVariable Long id, @RequestBody Webtoon updatedData) {
        return webtoonRepository.findById(id).map(webtoon -> {
            webtoon.setTitle(updatedData.getTitle());
            webtoon.setAuthor(updatedData.getAuthor());
            webtoon.setGenre(updatedData.getGenre());
            webtoon.setStatus(updatedData.getStatus());
            webtoon.setDescription(updatedData.getDescription());
            webtoon.setTags(updatedData.getTags());
            return webtoonRepository.save(webtoon);
        }).orElseThrow();
    }

    // 4. 작품 삭제
    @DeleteMapping("/{id}")
    public void deleteWebtoon(@PathVariable Long id) {
        webtoonRepository.deleteById(id);
    }

    // 5. [AI 기능] 줄거리를 받아 태그 추천받기
    @GetMapping("/recommend-tags")
    public List<String> recommendTags(@RequestParam String description) {
        String rawTags = geminiService.getRecommendedTags(description);
        // 결과가 "#판타지, #액션" 형태라면 리스트로 변환해서 반환
        return Arrays.stream(rawTags.split(","))
                     .map(tag -> tag.trim().replace("#", ""))
                     .collect(Collectors.toList());
    }
}