<!-- @ts-nocheck -->
<template>
  <v-container fluid class="pa-2 pa-sm-6">
    <!-- 1. 헤더 섹션 -->
    <v-row class="mb-4" align="center">
      <v-col cols="12" sm="8">
        <h2 class="text-h5 font-weight-black text-grey-darken-3">작품 마스터 관리</h2>
        <p class="text-caption text-grey mt-1">
          Pinia 스토어를 통해 실시간으로 데이터를 관리하며, 모든 변경 사항은 이력에 기록됩니다.
        </p>
      </v-col>
      <v-col cols="12" sm="4" :class="$vuetify.display.xs ? 'text-left' : 'text-right'">
        <v-btn
          color="primary"
          prepend-icon="mdi-plus"
          :block="$vuetify.display.xs"
          size="large"
          rounded="lg"
          elevation="2"
          @click="openModal(null)"
        >
          신규 작품 등록
        </v-btn>
      </v-col>
    </v-row>

    <!-- 2. 컨트롤러 (검색/필터/정렬) -->
    <v-card border flat class="rounded-lg mb-6 pa-4 shadow-sm bg-white">
      <v-row dense>
        <v-col cols="12" md="4" class="mb-2 mb-md-0">
          <v-text-field
            v-model="searchQuery"
            prepend-inner-icon="mdi-magnify"
            placeholder="작품명 또는 작가 검색"
            variant="underlined"
            color="primary"
            hide-details
          ></v-text-field>
        </v-col>
        <v-col cols="6" md="2">
          <v-select
            v-model="filterGenre"
            :items="['전체', '로맨스판타지', 'BL', '판타지', '에피소드', '로맨스', '스릴러', '스포츠']"
            label="장르"
            variant="underlined"
            hide-details
          ></v-select>
        </v-col>
        <v-col cols="6" md="2">
          <v-select
            v-model="filterStatus"
            :items="['전체', '연재중', '완결', '휴재']"
            label="상태"
            variant="underlined"
            hide-details
          ></v-select>
        </v-col>
        <v-col cols="12" md="4">
          <v-select
            v-model="sortBy"
            :items="[
              { title: '최신등록순', value: 'id_desc' },
              { title: '조회수 높은순', value: 'views_desc' },
              { title: '제목 가나다순', value: 'title_asc' },
            ]"
            label="정렬 방식"
            variant="underlined"
            hide-details
          ></v-select>
        </v-col>
      </v-row>
    </v-card>

    <!-- 3. 작품 리스트 -->
    <v-card border flat class="rounded-lg overflow-hidden shadow-sm" :loading="webtoonStore.loading">
      <v-list lines="two" class="pa-0">
        <v-list-item
          v-for="toon in paginatedWebtoons"
          :key="toon.id"
          class="py-3 py-sm-4 border-b px-2 px-sm-4"
        >
          <template v-slot:prepend>
            <div class="text-caption text-grey d-none d-sm-block mr-4" style="width: 30px">
              {{ toon.id }}
            </div>
            <v-avatar rounded="lg" size="52" size-sm="64" class="mr-3 mr-sm-4 border shadow-sm bg-white">
              <v-img :src="toon.thumbnail || 'https://via.placeholder.com/150x200?text=No+Image'" cover></v-img>
            </v-avatar>
          </template>

          <v-list-item-title class="font-weight-black text-body-2 text-sm-subtitle-1 mb-1">
            {{ toon.title }}
          </v-list-item-title>

          <v-list-item-subtitle class="d-flex align-center ga-1 ga-sm-2">
            <span class="text-caption text-sm-body-2 font-weight-bold text-grey-darken-1">{{ toon.author }}</span>
            <v-divider vertical inset class="mx-1 d-none d-sm-block"></v-divider>
            <v-chip
              size="x-small"
              :color="getGenreColor(toon.genre)"
              variant="flat"
              class="text-white font-weight-bold"
            >
              {{ toon.genre }}
            </v-chip>
          </v-list-item-subtitle>

          <template v-slot:append>
            <div class="text-right mr-6 d-none d-md-block">
              <div class="text-caption text-grey font-weight-bold">조회수</div>
              <div class="text-body-2 font-weight-black">
                {{ toon.viewCount?.toLocaleString() || 0 }}
              </div>
            </div>

            <v-chip
              :color="toon.status === '연재중' ? 'success' : 'grey-darken-1'"
              :size="$vuetify.display.xs ? 'x-small' : 'small'"
              variant="flat"
              class="font-weight-bold text-white mr-1 mr-sm-2"
            >
              {{ toon.status }}
            </v-chip>

            <div class="d-flex ga-1">
              <v-btn
                icon="mdi-pencil-outline"
                variant="text"
                color="blue-darken-1"
                size="small"
                @click="openModal(toon)"
              ></v-btn>
              <v-btn
                icon="mdi-delete-outline"
                variant="text"
                color="error"
                size="small"
                @click="deleteItem(toon)"
              ></v-btn>
            </div>
          </template>
        </v-list-item>

        <v-list-item
          v-if="paginatedWebtoons.length === 0"
          class="pa-10 text-center text-grey font-weight-bold"
        >
          데이터가 없거나 검색 결과가 없습니다.
        </v-list-item>
      </v-list>
    </v-card>

    <!-- 4. 페이지네이션 -->
    <v-pagination
      v-model="page"
      :length="pageCount"
      :total-visible="$vuetify.display.xs ? 3 : 5"
      rounded="lg"
      color="primary"
      class="mt-6"
    ></v-pagination>

    <!-- 5. 공통 수정/등록 다이얼로그 -->
    <WebtoonEditDialog v-model="isModalOpen" :item="selectedToon" @saved="onSaved" />

    <!-- 6. 삭제 확인 커스텀 다이얼로그 -->
    <v-dialog v-model="isDeleteModalOpen" max-width="400">
      <v-card class="rounded-xl pa-4 text-center">
        <v-card-text class="pt-4">
          <v-avatar color="error-lighten-4" size="70" class="mb-4">
            <v-icon color="error" icon="mdi-alert-circle-outline" size="40"></v-icon>
          </v-avatar>
          <h3 class="text-h6 font-weight-black mb-2">정말 삭제하시겠습니까?</h3>
          <p class="text-body-2 text-grey-darken-1">
            <b class="text-grey-darken-4">[{{ itemToDelete?.title }}]</b> 작품이 삭제됩니다.<br />
            삭제된 데이터는 복구할 수 없습니다.
          </p>
        </v-card-text>

        <v-card-actions class="pb-4 px-4 ga-2">
          <v-btn
            variant="tonal"
            color="grey"
            class="flex-grow-1 rounded-lg font-weight-bold"
            @click="isDeleteModalOpen = false"
          >
            취소
          </v-btn>
          <v-btn
            variant="flat"
            color="error"
            class="flex-grow-1 rounded-lg font-weight-bold"
            :loading="webtoonStore.loading"
            @click="confirmDelete"
          >
            삭제하기
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
  </v-container>
</template>

<script setup>
import { ref, computed, watch } from 'vue'
import { useWebtoonStore } from '@/stores/webtoonStore'
import { useSnackbarStore } from '@/stores/snackbar'

// 공통 편집 다이얼로그 임포트
import WebtoonEditDialog from '@/components/common/WebtoonEditDialog.vue'

const webtoonStore = useWebtoonStore()
const snackbar = useSnackbarStore()

// --- 필터 및 페이징 상태 ---
const searchQuery = ref('')
const filterGenre = ref('전체')
const filterStatus = ref('전체')
const sortBy = ref('id_desc')
const page = ref(1)
const itemsPerPage = 6

// --- 모달 상태 ---
const isModalOpen = ref(false)
const selectedToon = ref(null)

const isDeleteModalOpen = ref(false)
const itemToDelete = ref(null)

// --- 데이터 가공 (필터 -> 정렬 -> 페이징) ---
const filteredAndSortedWebtoons = computed(() => {
  let list = [...webtoonStore.webtoons]

  if (searchQuery.value) {
    const q = searchQuery.value.toLowerCase()
    list = list.filter((t) => t.title.toLowerCase().includes(q) || t.author.toLowerCase().includes(q))
  }

  if (filterGenre.value !== '전체') list = list.filter((t) => t.genre === filterGenre.value)
  if (filterStatus.value !== '전체') list = list.filter((t) => t.status === filterStatus.value)

  list.sort((a, b) => {
    if (sortBy.value === 'views_desc') return (b.viewCount || 0) - (a.viewCount || 0)
    if (sortBy.value === 'title_asc') return a.title.localeCompare(b.title)
    return b.id - a.id
  })

  return list
})

const paginatedWebtoons = computed(() => {
  const start = (page.value - 1) * itemsPerPage
  return filteredAndSortedWebtoons.value.slice(start, start + itemsPerPage)
})

const pageCount = computed(() => Math.ceil(filteredAndSortedWebtoons.value.length / itemsPerPage))

// 필터 변경 시 무조건 1페이지로 리셋
watch([searchQuery, filterGenre, filterStatus, sortBy], () => (page.value = 1))

// --- 편집/등록 로직 ---
const openModal = (item) => {
  selectedToon.value = item // null이면 등록, 객체면 수정
  isModalOpen.value = true
}

const onSaved = () => {
  // 저장(등록/수정) 성공 시 필요한 추가 작업이 있다면 기술
}

// --- 삭제 로직 ---
const deleteItem = (item) => {
  itemToDelete.value = item
  isDeleteModalOpen.value = true
}

const confirmDelete = async () => {
  if (!itemToDelete.value) return
  try {
    await webtoonStore.deleteWebtoon(itemToDelete.value.id)
    snackbar.showMessage(`[${itemToDelete.value.title}] 작품이 정상적으로 삭제되었습니다.`, 'success')
  } catch (error) {
    snackbar.showMessage('삭제 중 오류가 발생했습니다.', 'error')
  } finally {
    isDeleteModalOpen.value = false
    itemToDelete.value = null
  }
}

// --- 장르별 컬러 매핑 ---
const getGenreColor = (genre) => {
  const colors = {
    로맨스판타지: 'pink-lighten-1',
    BL: 'deep-purple-accent-2',
    판타지: 'blue-darken-2',
    에피소드: 'green-darken-1',
    로맨스: 'pink-accent-2',
    스릴러: 'orange-darken-4',
    스포츠: 'cyan-darken-3',
  }
  return colors[genre] || 'grey'
}
</script>

<style scoped>
.ga-1 { gap: 4px; }
.ga-2 { gap: 8px; }
.border-b { border-bottom: 1px solid #f0f0f0 !important; }
.v-list-item:hover { background-color: #f9f9f9; cursor: default; }

/* 페이지네이션 스타일 살짝 조정 */
:deep(.v-pagination__list) { justify-content: center; }
</style>