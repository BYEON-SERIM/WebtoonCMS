package com.example.cms.controller;

import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;
import java.util.Map;
import java.util.List;

@Service // 이 클래스를 스프링이 관리하는 '서비스 빈'으로 등록한다는 뜻입니다.
public class GeminiService {

    private final WebClient webClient;

    // 구글 AI 스튜디오에서 발급받은 본인의 API 키를 여기에 넣으세요.
    private final String apiKey = "AIzaSyCTZOmeYrC9NaoJi9Ad0jTP3ZW8I0ud6Sc"; 

    // 생성자: WebClient라는 '통신 도구'를 설정합니다.
    public GeminiService(WebClient.Builder webClientBuilder) {
        this.webClient = webClientBuilder
            .baseUrl("https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent")
            .build();
    }

    /**
     * 줄거리를 받아서 AI가 뽑은 태그를 반환하는 메서드
     */
    public String getRecommendedTags(String description) {
        // 1. AI에게 보낼 질문(프롬프트) 구성
        String prompt = description + " \n 이 웹툰 줄거리에 어울리는 태그 5개를 #태그1, #태그2 형식으로 뽑아줘.";

        // 2. 구글 API가 원하는 복잡한 JSON 형식을 자바의 Map으로 만듭니다.
        // 구조: { "contents": [ { "parts": [ { "text": "질문" } ] } ] }
        Map<String, Object> body = Map.of(
            "contents", List.of(
                Map.of("parts", List.of(
                    Map.of("text", prompt)
                ))
            )
        );

        // 3. 실제로 구글 서버에 POST 요청을 보냅니다.
        return webClient.post()
                .uri(uriBuilder -> uriBuilder.queryParam("key", apiKey).build()) // 주소 뒤에 ?key=... 붙이기
                .bodyValue(body) // 아까 만든 JSON 몸체 넣기
                .retrieve() // 실행!
                .bodyToMono(Map.class) // 응답을 Map 형태로 받기
                .map(response -> {
                    // 4. 구글이 준 복잡한 응답에서 우리가 원하는 '글자'만 파고 들어가서 꺼냅니다.
                    try {
                        List candidates = (List) response.get("candidates");
                        Map candidate = (Map) candidates.get(0);
                        Map content = (Map) candidate.get("content");
                        List parts = (List) content.get("parts");
                        Map part = (Map) parts.get(0);
                        return (String) part.get("text");
                    } catch (Exception e) {
                        return "태그 추출 중 오류 발생";
                    }
                })
                .block(); // 비동기 응답이 올 때까지 잠시 기다림 (공부 단계에선 이게 편합니다)
    }
}