package com.example.cms.controller;

import com.example.cms.domain.Webtoon;
import com.example.cms.repository.WebtoonRepository;
import com.example.cms.service.GeminiService;

import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/webtoons")
@RequiredArgsConstructor
public class WebtoonController {

    private final WebtoonRepository webtoonRepository;
    private final GeminiService geminiService;

    // 1. [GET] /api/webtoons -> 전체 목록 조회
    @GetMapping
    public List<Webtoon> getWebtoons() {
        return webtoonRepository.findAll();
    }

    // 2. [PUT] /api/webtoons/{id} -> 작품 정보 수정
    @PutMapping("/{id}")
    @Transactional // 수정 작업에는 트랜잭션이 필수입니다.
    public Webtoon updateWebtoon(@PathVariable("id") Long id, @RequestBody Webtoon updatedData) {
        return webtoonRepository.findById(id).map(webtoon -> {
            // 프론트에서 넘어온 모든 필드를 꼼꼼히 업데이트 해줘야 합니다.
            webtoon.setTitle(updatedData.getTitle());
            webtoon.setAuthor(updatedData.getAuthor());
            webtoon.setGenre(updatedData.getGenre());
            webtoon.setStatus(updatedData.getStatus());
            webtoon.setDescription(updatedData.getDescription());
            webtoon.setTags(updatedData.getTags());
            
            // 만약 프론트에서 thumbnail이나 viewCount도 같이 보낸다면 아래도 추가해야 함
            if (updatedData.getThumbnail() != null) webtoon.setThumbnail(updatedData.getThumbnail());
            if (updatedData.getViewCount() != null) webtoon.setViewCount(updatedData.getViewCount());
            
            return webtoonRepository.save(webtoon);
        }).orElseThrow(() -> new RuntimeException("ID " + id + "번 작품을 찾을 수 없습니다."));
    }


    // 3. [GET] /api/webtoons/recommend-tags -> AI 태그 추천
    @GetMapping("/recommend-tags")
    public String recommendTags(@RequestParam("description") String description) {
        return geminiService.getRecommendedTags(description);
    }
    
 // 2. 순서 저장 API
    @PutMapping("/order")
    @Transactional
    public void updateOrder(@RequestBody List<Long> webtoonIds) {
        for (int i = 0; i < webtoonIds.size(); i++) {
            Long id = webtoonIds.get(i);
            Webtoon webtoon = webtoonRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("해당 웹툰이 없습니다. id=" + id));
            webtoon.setSortOrder(i); // 리스트의 인덱스 번호를 순서로 저장
        }
    }
}