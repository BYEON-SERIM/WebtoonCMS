package com.example.cms.config;

import com.example.cms.domain.CommonCode;
import com.example.cms.domain.DailyStat;
import com.example.cms.domain.Webtoon;
import com.example.cms.domain.WebtoonLog;
import com.example.cms.repository.CommonCodeRepository;
import com.example.cms.repository.DailyStatRepository;
import com.example.cms.repository.WebtoonLogRepository;
import com.example.cms.repository.WebtoonRepository;
import org.springframework.boot.CommandLineRunner;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;
import java.util.Random;

@Configuration
public class DataInitializer {

    @Bean
    CommandLineRunner initData(
            WebtoonRepository webtoonRepository, 
            WebtoonLogRepository logRepository,
            DailyStatRepository statRepository,
            CommonCodeRepository commonCodeRepository) { 
        
        return args -> {

            // 웹툰 데이터 
            if (webtoonRepository.count() == 0) {
                webtoonRepository.saveAll(List.of(
                    Webtoon.builder().title("외모지상주의").author("박태준").genre("에피소드").status("연재중").viewCount(95000000L).sortOrder(1).build(),
                    Webtoon.builder().title("전지적 독자 시점").author("싱숑").genre("판타지").status("연재중").viewCount(78000000L).sortOrder(2).build(),
                    Webtoon.builder().title("내 남편과 결혼해줘").author("성소작").genre("로맨스").status("완결").viewCount(45000000L).sortOrder(3).build(),
                    Webtoon.builder().title("재혼 황후").author("알파타르트").genre("로맨스판타지").status("연재중").viewCount(62000000L).sortOrder(4).build(),
                    Webtoon.builder().title("신의 탑").author("SIU").genre("판타지").status("연재중").viewCount(89000000L).sortOrder(5).build()
                ));
            }

            // 로그 데이터
            if (logRepository.count() == 0) {
                logRepository.saveAll(List.of(
                    new WebtoonLog("[외모지상주의] 메인 큐레이션 1위로 이동", "deep-purple"),
                    new WebtoonLog("[신의 탑] AI 태그 자동 생성 완료", "primary")
                ));
            }

            // 조회수 통계 데이터 (최근 30일)
            if (statRepository.count() == 0) {
                List<DailyStat> stats = new ArrayList<>();
                LocalDate today = LocalDate.now();
                Random random = new Random();
                long baseViews = 5000000L;

                for (int i = 30; i >= 0; i--) {
                    long randomTrend = (30 - i) * 100000L; 
                    long dailyRandom = random.nextInt(1000000); 	
                    
                    stats.add(DailyStat.builder()
                            .statDate(today.minusDays(i))
                            .dailyViews(baseViews + randomTrend + dailyRandom)
                            .build());
                }
                statRepository.saveAll(stats);
                System.out.println(">> 최근 30일 조회수 통계 데이터 삽입 완료!");
            }
            
            // 공통 코드 데이터
            if (commonCodeRepository.count() == 0) {
                // 저장할 리스트 생성
                List<CommonCode> genreList = List.of(
                    CommonCode.builder().groupCode("GENRE").codeValue("ROMANCE_FAN").codeName("로맨스판타지").attr1("pink-lighten-1").build(),
                    CommonCode.builder().groupCode("GENRE").codeValue("BL").codeName("BL").attr1("deep-purple-accent-2").build(),
                    CommonCode.builder().groupCode("GENRE").codeValue("FANTASY").codeName("판타지").attr1("blue-darken-2").build(),
                    CommonCode.builder().groupCode("GENRE").codeValue("EPISODE").codeName("에피소드").attr1("green-darken-1").build(),
                    CommonCode.builder().groupCode("GENRE").codeValue("ROMANCE").codeName("로맨스").attr1("pink-accent-2").build(),
                    CommonCode.builder().groupCode("GENRE").codeValue("THRILLER").codeName("스릴러").attr1("orange-darken-4").build(),
                    CommonCode.builder().groupCode("GENRE").codeValue("SPORTS").codeName("스포츠").attr1("cyan-darken-3").build()
                );

                // 반드시 commonCodeRepository 인지 확인!!
                commonCodeRepository.saveAll(genreList);
                System.out.println(">> 장르 공통 코드 데이터 삽입 완료!");
            }
        };
    }
}